<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Migrating from a local database to S3 - Rust Forge</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Supplemental documentation for contributing to The Rust Programming Language">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../index.html">Overview</a></li><li class="expanded "><a href="../chat/index.html">Chat Platforms</a></li><li><ol class="section"><li class="expanded "><a href="../chat/discord.html">Discord</a></li><li class="expanded "><a href="../chat/email.html">Email</a></li><li class="expanded "><a href="../chat/zulip.html">Zulip</a></li><li><ol class="section"><li class="expanded "><a href="../chat/zulip/moderation.html">Moderation</a></li></ol></li></ol></li><li class="expanded "><a href="../core/index.html">Core</a></li><li><ol class="section"><li class="expanded "><a href="../core/blogs.html">Rust Blog Guidelines</a></li></ol></li><li class="expanded "><a href="../community/index.html">Community</a></li><li><ol class="section"><li class="expanded "><a href="../community/survey-faq.html">State of Rust Survey FAQ</a></li></ol></li><li class="expanded "><a href="../compiler/index.html">Compiler</a></li><li><ol class="section"><li class="expanded "><a href="../compiler/cross-compilation/index.html">Cross Compilation</a></li><li><ol class="section"><li class="expanded "><a href="../compiler/cross-compilation/windows.html">Windows</a></li></ol></li><li class="expanded "><a href="../compiler/triage-meeting.html">Triage Meeting</a></li><li class="expanded "><a href="../compiler/steering-meeting.html">Steering Meeting</a></li><li><ol class="section"><li class="expanded "><a href="../compiler/steering-meeting/submit.html">Submitting a proposal</a></li><li class="expanded "><a href="../compiler/steering-meeting/how-to-run-planning.html">How to run the planning meeting</a></li><li class="expanded "><a href="../compiler/steering-meeting/how-to-run-design.html">How to run a design meeting</a></li></ol></li></ol></li><li class="expanded "><a href="../crates-io/index.html">crates.io</a></li><li><ol class="section"><li class="expanded "><a href="../crates-io/crate-removal.html">Crate removal</a></li></ol></li><li class="expanded "><a href="../docs-rs/index.html">docs.rs</a></li><li><ol class="section"><li class="expanded "><a href="../docs-rs/add-dependencies.html">Adding dependencies to the build environment</a></li><li class="expanded "><a href="../docs-rs/no-docker-compose.html">Developing without docker-compose</a></li><li class="expanded "><a href="../docs-rs/self-hosting.html">Self-hosting a docs.rs instance</a></li><li class="expanded "><a href="../docs-rs/maintenance.html">Maintenance procedures</a></li><li class="expanded "><a href="../docs-rs/migrate-s3.html" class="active">Migrating from a local database to S3</a></li></ol></li><li class="expanded "><a href="../github.html">GitHub</a></li><li class="expanded "><a href="../governance/index.html">Governance</a></li><li class="expanded "><a href="../infra/index.html">Infrastructure</a></li><li><ol class="section"><li class="expanded "><a href="../infra/other-installation-methods.html">Other Installation Methods</a></li><li class="expanded "><a href="../infra/channel-layout.html">Release Channel Layout</a></li><li class="expanded "><a href="../infra/service-infrastructure.html">Service Infrastructure</a></li><li class="expanded "><a href="../infra/team-maintenance.html">Team Maintenance</a></li><li class="expanded "><a href="../infra/toolstate.html">The Toolstate System</a></li><li class="expanded "><a href="../infra/policies/index.html">Policies</a></li><li><ol class="section"><li class="expanded "><a href="../infra/policies/broken-nightlies.html">Broken nightlies</a></li></ol></li><li class="expanded "><a href="../infra/guidelines/index.html">Guidelines</a></li><li><ol class="section"><li class="expanded "><a href="../infra/guidelines/static-websites.html">Static websites</a></li></ol></li><li class="expanded "><a href="../infra/docs/index.html">Documentation</a></li><li><ol class="section"><li class="expanded "><a href="../infra/docs/aws-access.html">AWS access for team members</a></li><li class="expanded "><a href="../infra/docs/aws-access-management.html">AWS access management</a></li><li class="expanded "><a href="../infra/docs/bastion.html">Bastion server</a></li><li class="expanded "><a href="../infra/docs/crater-agents.html">Crater agents</a></li><li class="expanded "><a href="../infra/docs/discord-mods-bot.html">Discord moderation bot</a></li><li class="expanded "><a href="../infra/docs/dns.html">Domain names and DNS</a></li><li class="expanded "><a href="../infra/docs/docs-rs.html">docs.rs</a></li><li class="expanded "><a href="../infra/docs/ecs-services.html">ECS services management</a></li><li class="expanded "><a href="../infra/docs/monitoring.html">Monitoring</a></li><li class="expanded "><a href="../infra/docs/rust-bots.html">rust-bots server</a></li><li class="expanded "><a href="../infra/docs/rustc-ci.html">rust-lang/rust CI</a></li></ol></li></ol></li><li class="expanded "><a href="../lang/index.html">Language</a></li><li><ol class="section"><li class="expanded "><a href="../lang/rfc-merge-procedure.html">RFC Merge Procedure</a></li><li class="expanded "><a href="../lang/triage-meeting-procedure.html">Triage Meeting Procedure</a></li></ol></li><li class="expanded "><a href="../libs/index.html">Libs</a></li><li><ol class="section"><li class="expanded "><a href="../libs/maintaining-std.html">Maintaining the standard library</a></li></ol></li><li class="expanded "><a href="../release/index.html">Release</a></li><li><ol class="section"><li class="expanded "><a href="../release/beta-backporting.html">Beta Backporting</a></li><li class="expanded "><a href="../release/platform-support.html">Platform Support</a></li><li class="expanded "><a href="../release/release-notes.html">Preparing Release Notes</a></li><li class="expanded "><a href="../release/process.html">Release Process</a></li><li class="expanded "><a href="../release/rollups.html">Rollup Procedure</a></li><li class="expanded "><a href="../release/triage-procedure.html">Triage Procedure</a></li><li class="expanded "><a href="../release/crater.html">Triaging Crater Runs</a></li></ol></li><li class="expanded "><a href="../archive/index.html">Archive</a></li><li><ol class="section"><li class="expanded "><a href="../archive/fott.html">Friends of the Tree</a></li><li class="expanded "><a href="../archive/release-history.html">Release History</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust Forge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/rust-lang/rust-forge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#migrating-from-a-local-database-to-s3" id="migrating-from-a-local-database-to-s3">Migrating from a local database to S3</a></h1>
<p>If you're running your own instance of docs.rs for personal development, and you'd like to test out the S3 integration, there are a couple steps involved. It's mostly straightforward, but there's at least one major caveat that should be taken into account.</p>
<h2><a class="header" href="#requirements" id="requirements">Requirements</a></h2>
<p>Since docs.rs uses a fixed bucket name to upload files, you'll need to set up an independent server that implements the Amazon S3 API. <a href="https://min.io/">Minio</a> is an example of a server you can set up. Instructions for installing and configuring Minio (or any S3-compliant provider) are beyond the scope of this article.</p>
<h2><a class="header" href="#configuring-your-docsrs-instance" id="configuring-your-docsrs-instance">Configuring your docs.rs instance</a></h2>
<p>Once you have your server and credentials set up, you need to tell the docs.rs server to use it. You'll need to add some extra environment variables to the environment file you use to configure docs.rs. It uses the <code>S3_ENDPOINT</code> variable to determine where to call, and the other variables to configure its access privileges. The available environment variables are documented in <code>rusoto</code>'s <a href="https://docs.rs/rusoto_credential/0.40.0/rusoto_credential/struct.EnvironmentProvider.html"><code>EnvironmentProvider</code></a>.</p>
<pre><code class="language-text">AWS_ACCESS_KEY_ID=&lt;access key&gt;
AWS_SECRET_ACCESS_KEY=&lt;access secret&gt;
S3_ENDPOINT=&lt;endpoint url&gt;
</code></pre>
<h2><a class="header" href="#migrating-files-out-of-the-database" id="migrating-files-out-of-the-database">Migrating files out of the database</a></h2>
<p>Before you restart the process to load the new credentials, the files that are currently in the local database need to be migrated out to S3. Once docs.rs sees that it has AWS credentials in its environment, it will stop reading from the <code>files</code> table entirely. Therefore, to properly transition to using the new file storage, you need to run an extra command to upload them. It's helpful to lock the build queue while this is happening, so that no new files will sneak in while the migration happens.</p>
<pre><code class="language-sh">cratesfyi build lock
# edit the environment file with the above variables if you haven't already
cratesfyi database move-to-s3 # this will take a while, depending on the size of your database
sudo systemctl restart cratesfyi # or however you manage your docs.rs service
# verify that files are loading from S3/Minio/etc
cratesfyi build unlock
</code></pre>
<p>Once this is done, new crate builds will upload files directly to your file storage service rather than into the database. The <code>move-to-s3</code> command will remove rows from the <code>files</code> table in the database as it uploads them, so once you're done, you can compact the database to shrink its on-disk size.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../docs-rs/maintenance.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../github.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../docs-rs/maintenance.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../github.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../js/moment.min.js"></script>
        
        <script type="text/javascript" src="../js/index.js"></script>
        

        

    </body>
</html>
